<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>网页源码获取小程序 | ss的小屋</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />

  <meta name="generator" content="ss的小屋">

  
  
  

  
</head>


<body class="post-template">

  <header class="site-head"  style="background-image: url(//blog.ghost.org/content/images/2013/Nov/cover.png)" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="//blog.ghost.org/content/images/2013/Nov/bloglogo_1-1.png" alt="Blog Logo"/></a> 
            <h1 class="blog-title">ss的小屋</h1>
            <h2 class="blog-description"></h2>
        </div>
    </div>
</header>
  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2015-03-22T02:27:01.000Z" itemprop="datePublished">
          2015-03-22
      </time>
    
</span>
    <h1 class="post-title">网页源码获取小程序</h1>
    <section class="post-content">
      <p>最近需要编写一个获取网页源代码的小程序，本来以为是很简单的事情，没有想到却出了一些意想不到的问题。最简单的方法，只要几行代码就能搞定了</p>
<p>[java]<br>HttpURLConnection connection = (HttpURLConnection) new URL(&quot;<a href="http://www.163.com&quot;).openConnection(" target="_blank" rel="external">http://www.163.com&quot;).openConnection(</a>);<br>InputStream inputStream = connection.getInputStream();<br>int len;<br>StringBuilder stringBuilder = new StringBuilder();<br>byte[] bytes = new byte[1024];<br>while ( (len = inputStream.read(bytes)) &gt; 0) {<br>    stringBuilder.append(new String(bytes, 0, len));<br>}<br>connection.disconnect();<br>String text = stringBuilder.toString();<br>System.out.println(text);<br>[/java]</p>
<p>很快我就发现了问题，有的网页编码是UTF-8，有的是gb2312。可是编码必须在读入之间就指定，这就有了矛盾。有没有这样一种编码，它可以无损转换到其他任何编码呢，有——8859_1。</p>
<a id="more"></a>
<p>思路就是，先统一用8859_1获取到网页的内容，然后转换成网页本来应该有的编码。</p>
<p>网页的编码会在&lt;meta&gt;标签里指定</p>
<p>[html collapse=”0”]<br>&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=gb2312&quot; /&gt;<br>[/html]</p>
<p>使用正则表达式匹配出标签中指定的编码，改进后的代码如下。</p>
<p>[java]<br>public String decode(InputStream is) throws IOException {<br>        StringBuilder sb = new StringBuilder();<br>        byte[] bytes = new byte[BLOCK_SIZE];<br>        int len, totalLen = 0;<br>        StringBuilder tmpSb = new StringBuilder();<br>        String head;<br>        boolean found = false;<br>        Pattern encodingPattern = Pattern.compile(ENCODING_TAG, Pattern.CASE_INSENSITIVE);<br>        String encoding = DEFAULT_ENCODING;<br>        while ((len = is.read(bytes)) &gt; 0) {<br>            totalLen += len;<br>            sb.append(stripEmptyLine(new String(bytes, 0, len, &quot;8859_1&quot;)));<br>            if (!found) {<br>                Matcher m = encodingPattern.matcher(sb.toString());<br>                if (m.find()) {<br>                    found = true;<br>                    encoding = m.group(1);<br>                    System.out.println(encoding);<br>                }<br>            }<br>        }<br>        return new String(sb.toString().getBytes(&quot;8859_1&quot;), encoding);<br>    }<br>[/java]</p>
<p>如此，我们就按照正确的编码方式获取到了网页的源码。 可是这还没完，我发现某些网站比较“坑”，比如 baidu.com，我获取到了这样一段东西，显然不是我想要的。</p>
<p>[html collapse=”0”] &lt;html&gt; &lt;meta http-equiv=&quot;refresh&quot; content=&quot;0;url=<a href="http://www.baidu.com/&quot;&amp;gt" target="_blank" rel="external">http://www.baidu.com/&quot;&amp;gt</a>; &lt;/html&gt; [/html]</p>
<p>其实他的意思是，0秒以后刷新，并且跳转到<a href="http://www.baidu.com。那么只要在获取到源码以后判断一下，如果有这样的标签就手动跳转。这次我用到了[Jsoup](http://jsoup.org)库。" target="_blank" rel="external">http://www.baidu.com。那么只要在获取到源码以后判断一下，如果有这样的标签就手动跳转。这次我用到了[Jsoup](http://jsoup.org)库。</a></p>
<p>[java]<br>URL url = new URL(pageURL);<br>String text = null;<br>boolean needRefresh;<br>do {<br>    needRefresh = false;<br>    HttpURLConnection connection = (HttpURLConnection) url.openConnection();<br>    connection.connect();<br>    text = new HtmlInputStreamDecoder().decode(connection.getInputStream());<br>    String head = text.substring(0, text.length()&gt;1000?1000:text.length());<br>    Document doc = Jsoup.parse(head);<br>    org.jsoup.select.Elements metas = doc.getElementsByTag(&quot;meta&quot;);<br>    for(org.jsoup.nodes.Element meta:metas){<br>        if (meta.hasAttr(&quot;http-equiv&quot;) &amp;&amp; meta.attr(&quot;http-equiv&quot;).equals(&quot;refresh&quot;)) {<br>            String content = meta.attr(&quot;content&quot;);<br>            if (content.contains(&quot;url&quot;)) {<br>                url = new URL(content.split(&quot;;&quot;)[1].substring(&quot;url=&quot;.length()));<br>                needRefresh = true;<br>            }<br>        }<br>    }<br>    connection.disconnect();<br>} while (needRefresh);<br>[/java]</p>
<p>这样程序就可以处理大多数网页了</p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>jiashuai</h4>
    <p>A designer, developer and entrepreneur. Spends his time travelling the world with a bag of kites. Likes journalism and publishing platforms.</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://yoursite.com/2015/03/22/e7-bd-91-e9-a1-b5-e6-ba-90-e7-a0-81-e8-8e-b7-e5-8f-96-e5-b0-8f-e7-a8-8b-e5-ba-8f/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2015/03/22/e7-bd-91-e9-a1-b5-e6-ba-90-e7-a0-81-e8-8e-b7-e5-8f-96-e5-b0-8f-e7-a8-8b-e5-ba-8f/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://yoursite.com/2015/03/22/e7-bd-91-e9-a1-b5-e6-ba-90-e7-a0-81-e8-8e-b7-e5-8f-96-e5-b0-8f-e7-a8-8b-e5-ba-8f/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2015/03/18/tomcat-e4-b8-ad-e7-9a-84-e9-bb-98-e8-ae-a4-e7-bc-96-e7-a0-81-e9-97-ae-e9-a2-98/">
        Tomcat中的默认编码问题 →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h1>

    
</div>
</main>


  
<footer class="site-footer">
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">ss的小屋</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>






</body>
</html>
